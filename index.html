<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbwzXnjhYM01zAgraWJSm3tb2CVfQh53md19ow95ZHhdEtQq4dirDBYXgKQUWC73-j0Hqg/exec";
const form = document.getElementById('examForm');
const slip = document.getElementById('slip');
const slipDetails = document.getElementById('slipDetails');

form.addEventListener('submit', async e => {
  e.preventDefault();

  const data = new FormData(form);
  const file = data.get('screenshot');

  if (!file || !file.name) {
    alert("⚠️ कृपया payment screenshot upload करें।");
    return;
  }

  // FileReader से base64 conversion
  const reader = new FileReader();
  reader.onload = async () => {
    const base64Screenshot = reader.result.split(',')[1]; // "data:image/png;base64,...."
    
    // JSON payload तैयार
    const payload = {
      name: data.get('name'),
      education: data.get('education'),
      school: data.get('school'),
      gender: data.get('gender'),
      email: data.get('email'),
      mobile: data.get('mobile'),
      address: data.get('address'),
      txnid: data.get('txnid'),
      screenshot: base64Screenshot
    };

    try {
      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(payload),
        headers: { "Content-Type": "application/json" }
      });
      const result = await res.json();
      if(result.status !== "success") throw new Error(result.message || 'Error saving data');
    } catch(err) {
      alert("❌ डेटा Google शीट में नहीं जा सका, पर प्रवेश पत्र दिखाया जा रहा है।");
      console.error(err);
    }

    // Slip दिखाएँ
    slipDetails.innerHTML = `
      <p><b>नाम:</b> ${escapeHtml(payload.name)}</p>
      <p><b>शिक्षा:</b> ${escapeHtml(payload.education)}</p>
      <p><b>विद्यालय / कॉलेज:</b> ${escapeHtml(payload.school)}</p>
      <p><b>लिंग:</b> ${escapeHtml(payload.gender)}</p>
      <p><b>मोबाइल नंबर:</b> ${escapeHtml(payload.mobile)}</p>
      <p><b>पता:</b> ${escapeHtml(payload.address)}</p>
      <p><b>Transaction ID:</b> ${escapeHtml(payload.txnid)}</p>
    `;
    form.style.display = 'none';
    slip.style.display = 'block';
    window.scrollTo(0,0);
  };
  reader.readAsDataURL(file); // Base64 में पढ़ो
});

function resetPage(){
  form.reset();
  form.style.display = 'block';
  slip.style.display = 'none';
  slipDetails.innerHTML = '';
}

function escapeHtml(text){
  if(!text) return '';
  return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
}
</script>
